<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="stylesheet" href="css/framework7.ios.min.css">
    <link rel="stylesheet" href="css/framework7.ios.colors.min.css">
    <link rel="stylesheet" href="css/framework7.material.min.css">
    <link rel="stylesheet" href="css/framework7.material.colors.min.css">
    <link rel="stylesheet" href="css/upscroller.css">
    <link rel="stylesheet" href="css/my-app.css">
    <link rel="stylesheet" href="css/base.css">

    <meta http-equiv="content-type" content="text/html; charset=UTF-8">

    <script src="http://app.miwifi.com/js/router_request.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/vue"></script>


    <script type="text/javascript" src="js/jquery.min.js"></script>


    <title>Shadowsocks</title>
    <meta name="viewport"
          content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <link href="css/reset.css" rel="stylesheet" type="text/css">
    <link href="css/mui-switch.css" rel="stylesheet" type="text/css">

</head>

<body>
<div id="router_app" class="views">
    <div class="view view-main">
        <div class="navbar">
            <div class="navbar-inner">
                <table width="100%">
                    <tr>
                        <td><font colour="#FFFFFF">插件状态</font>&nbsp;<font size="2px" color="#d3d3d3">版本:{{version}}&nbsp;&nbsp;
                            <font color="red">进程:{{status}}</font></font></td>
                        <td align="right"><input width="150" v-model="run_status"
                                                 @click="runSS(run_status)"
                                                 class="mui-switch mui-switch-anim" type="checkbox"></td>
                    </tr>
                </table>

            </div>
        </div>

        <a href="javascript:"
           v-show="nowIndex===0&&nodeList.length>0" @click="saveNodeList()"
           class="floating-button color-red"><i
                class="icon">保存</i></a>

        <div class="navbar-fixed pages navbar-through toolbar-through">
            <div class="page-content">

                <ul class="tabs nav nav-tabs" id="myTab">
                    <li v-for="(item,index) in tabsParam"
                        @click="toggleTabs(index)"
                        :class="{active:index==nowIndex}"><a>{{item}}</a></li>
                </ul>

                <div class="tabs tab-content" v-show="nowIndex===0">
                    <div class="tab-pane active">
                        <div class="list-block">
                            工作状态
                            <hr/>
                            <form>
                                <table align="center" style="width: 90%">
                                    <tr style="width: 30%">
                                        <td class="text_right">插件版本：</td>
                                        <td><input v-model="plugin_status.version" type="text" disabled="disabled"
                                                   placeholder="---">
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text_right">进程状态：</td>
                                        <td><input v-model="plugin_status.pid" type="text" disabled="disabled"
                                                   placeholder="7000"
                                                  >
                                        </td>
                                    </tr>
                                    <tr>
                                        <td class="text_right">SS节点：</td>
                                        <td><input v-model="plugin_status.node" type="text" disabled="disabled"
                                                   placeholder="node"></td>
                                    </tr>
                                    <tr>
                                        <td class="text_right">DNS状态：</td>
                                        <td><input v-model="plugin_status.dns" disabled="disabled" placeholder="dns"
                                                   type="text"></td>
                                    </tr>


                                </table>
                                <br/>
                                <hr/>

                            </form>
                            <br/>

                            节点列表


                            <div style="width: 100%; overflow: hidden">

                                <ul>
                                    <li class=" item-content list-item " v-for="(node,index) in nodeList "
                                        data-type="0">

                                        <div class="item-inner" @touchstart.capture="touchStart"
                                             @touchend.capture="touchEnd" @click="skip">
                                            <div style="width: 100%;">
                                                <table>
                                                    <tr>
                                                        <td>名称:</td>
                                                        <td><input v-model="node.name" type="text" placeholder="名称"/>
                                                        </td>
                                                    </tr>
                                                </table>
                                                <table>

                                                    <tr>
                                                        <td width="45">地址:</td>
                                                        <td><input v-model="node.server" type="text"
                                                                   placeholder="127.0.0.1">
                                                        </td>
                                                        <td width="45">端口:</td>
                                                        <td width="60"><input v-model="node.server_port" type="text"
                                                                              placeholder="8989"></td>

                                                    </tr>
                                                </table>
                                                <table>
                                                    <tr>
                                                        <td> 密码:</td>

                                                        <td>
                                                            <input v-model="node.password" type="text"
                                                                   placeholder="密码"></td>
                                                    </tr>
                                                </table>
                                                <table>
                                                    <tr>
                                                        <td> 工作模式:</td>

                                                        <td>
                                                            <select v-model="node.model">
                                                                <option value="1">gfwlist模式</option>
                                                                <option value="2">大陆白名单模式</option>
                                                                <option value="3">游戏模式</option>
                                                                <option value="5">全局代理模式</option>
                                                                <option value="6">回国模式</option>
                                                            </select></td>
                                                    </tr>
                                                </table>

                                                <table>
                                                    <tr>
                                                        <td> 加密方式:</td>

                                                        <td>
                                                            <select v-model="node.method">
                                                                <option value="none">none</option>
                                                                <option value="rc4">rc4</option>
                                                                <option value="rc4-md5">rc4-md5</option>
                                                                <option value="rc4-md5-6">rc4-md5-6</option>
                                                                <option value="aes-128-gcm">AEAD_AES_128_GCM</option>
                                                                <option value="aes-192-gcm">AEAD_AES_192_GCM</option>
                                                                <option value="aes-256-gcm">AEAD_AES_256_GCM</option>
                                                                <option value="aes-128-cfb">aes-128-cfb</option>
                                                                <option value="aes-192-cfb">aes-192-cfb</option>
                                                                <option value="aes-256-cfb" selected="">aes-256-cfb
                                                                </option>
                                                                <option value="aes-128-ctr">aes-128-ctr</option>
                                                                <option value="aes-192-ctr">aes-192-ctr</option>
                                                                <option value="aes-256-ctr">aes-256-ctr</option>
                                                                <option value="camellia-128-cfb">camellia-128-cfb
                                                                </option>
                                                                <option value="camellia-192-cfb">camellia-192-cfb
                                                                </option>
                                                                <option value="camellia-256-cfb">camellia-256-cfb
                                                                </option>
                                                                <option value="bf-cfb">bf-cfb</option>
                                                                <option value="cast5-cfb">cast5-cfb</option>
                                                                <option value="idea-cfb">idea-cfb</option>
                                                                <option value="rc2-cfb">rc2-cfb</option>
                                                                <option value="seed-cfb">seed-cfb</option>
                                                                <option value="salsa20">salsa20</option>
                                                                <option value="chacha20">chacha20</option>
                                                                <option value="chacha20-ietf">chacha20-ietf</option>
                                                                <option value="chacha20-ietf-poly1305">
                                                                    chacha20-ietf-poly1305
                                                                </option>
                                                                <option value="xchacha20-ietf-poly1305">
                                                                    xchacha20-ietf-poly1305
                                                                </option>
                                                            </select>
                                                        </td>
                                                    </tr>
                                                </table>

                                                <table>
                                                    <tr>
                                                        <td> 本地代理端口:</td>

                                                        <td>
                                                            <input width="150" v-model="node.local_port"
                                                                   type="text" placeholder="1080">
                                                        </td>
                                                    </tr>
                                                </table>

                                                <table>
                                                    <tr>
                                                        <td> 混淆 (obfs):</td>

                                                        <td>
                                                            <input width="150" v-model="node.use_encryption"
                                                                   class="mui-switch mui-switch-anim" type="checkbox">
                                                        </td>
                                                    </tr>
                                                </table>


                                            </div>
                                        </div>

                                        <div class="swipeout-actions-right" @click="deleteItem(index)"
                                             :data-index="index">
                                            <a class="swipeout-delete">删除</a></div>
                                    </li>
                                </ul>

                            </div>

                            <div @click="addItem()" style="margin-top: 10px" class="button button-fill"
                                 style="width: 100%;"><font size="150">+</font>
                            </div>
                            <hr/>


                        </div>
                    </div>
                </div>
                <div class="tabs tab-content" v-show="nowIndex===1">

                    <div class="tab-pane active">
                        <div class="list-block">

                            <br/>
                            局域网控制

                            <div style="width: 100%; overflow: hidden">

                                <ul>
                                    <li class=" item-content list-item " v-for="(item,index) in lanList "
                                        data-type="0">

                                        <div class="item-inner" @touchstart.capture="touchStart"
                                             @touchend.capture="touchEnd" @click="skip">
                                            <div style="width: 100%;">

                                                <table width="100%">

                                                    <tr>
                                                        <th><select v-model="item.type">
                                                            <option value="0">请选择</option>
                                                            <option value="1">主机名:</option>
                                                            <option value="2">IP:</option>
                                                            <option value="3">MAC:</option>
                                                        </select></th>
                                                        <td><input type="text" v-model="item.value"></td>
                                                        <td class="text_right"><input width="150" v-model="item.use_ss"
                                                                   class="mui-switch mui-switch-anim" type="checkbox">
                                                        </td>
                                                    </tr>

                                                </table>
                                            </div>
                                        </div>

                                        <div class="swipeout-actions-right" @click="deleteLanItem(index)"
                                             :data-index="index">
                                            <a class="swipeout-delete">删除</a></div>
                                    </li>
                                </ul>

                            </div>

                            <div @click="addLanItem()" style="margin-top: 10px" class="button button-fill"
                                 style="width: 100%;"><font size="150">+</font>
                            </div>
                        </div>
                    </div>
                    <hr/>
                </div>

                <div class="tabs tab-content" v-show="nowIndex===2">
                    <div class="help">
                        <p>frp 是一个可用于内网穿透的高性能的反向代理应用，支持 tcp, udp, http, https 协议。</p>
                        <p>*基本配置和自定义配置是分离的，相互不会影响</p>
                        <font color="red">*点击保存，会保存当前页面配置，且frpc读取的是最新保存的配置</font>
                        <p>*保存配置后请重启frpc进程以便配置生效</p>
                        <p>*列表左滑可以删除</p>
                        <p>

                            <br/>

                        <hr/>
                        捐助作者：
                        <form name="atool_alipay_img_form" style="padding-bottom: 0;border:none;" method="post"
                              action="https://shenghuo.alipay.com/send/payment/fill.htm" target="_blank"
                              accept-charset="GBK" onsubmit="document.charset='gbk';"><input type="hidden"
                                                                                             value="mtjo_00@163.com"
                                                                                             name="optEmail"><input
                                type="hidden" value="1" name="payAmount"><input type="hidden" name="title"
                                                                                placeholder="付款说明" value=""><input
                                type="image" value="支付宝收款" src="http://www.atool.org/res/alipay_1.png" name="pay">
                        </form>
                        </p>
                        <br/>
                        支付宝打赏：
                        <center><img width="100%" src="alipay.JPG"></center>

                        <br/>
                        微信打赏：
                        <center><img width="100%" src="wechar.JPG"></center>
                    </div>
                </div>


            </div>
        </div>

    </div>
</div>
<div class="toast-wrap">
    <span class="toast-msg"></span>
</div>

<script>
    var nodeList = [];
    var router_app = new Vue({
        el: '#router_app',
        data: {
            tabsParam: ['基本配置', '局域网控制', "?"],//（这个也可以用对象key，value来实现）
            nowIndex: 0,//默认激活状态
            user_config: "",
            plugin_status: {},
            nodeList: [],
            lanList: [],
            version: "----",
            status: "----",
            run_status: false,
            startX: 0,
            endX: 0,
        },
        methods: {
            toggleTabs: function (index) {
                this.nowIndex = index;
            },
            addItem: function () {
                router_app.$data.nodeList.push({
                    "server": "",
                    "server_port": '',
                    "local_port": '1081',
                    "local_address": "127.0.0.1",
                    "password": "",
                    "timeout": 600,
                    "method": ""
                })
            },
            addLanItem: function () {
                router_app.$data.lanList.push({

                    "type": 0,
                    "value": "",
                    "use_ss": true
                })
            },
            saveNodeList: function () {

                configData = encodeURIComponent(JSON.stringify(router_app.$data.nodeList));
                //alert(configData);
                //详细列表设置
                routerRequest.request({
                    path: "/api-third-party/service/datacenter/set_config",
                    type: "GET",
                    data: {
                        appId: appId,
                        key: "nodeList",
                        value: configData
                    },
                    success: function (data) {
                        toast(data);
                        var response = jQuery.parseJSON(data);
                        if (response.code != 0) {
                            console.log(data);
                            toast("保存配置错误：" + response.msg);
                            return;
                        }

                        //alert("保存配置成功！");
                        toast("保存配置成功！");

                    },
                    error: function (data) {
                        console.log("set_config:", data);
                        alert("网络失败");
                    }
                });

                tmp =router_app.$data.nodeList[0];

                delete tmp.name;
                delete tmp.model;

                routerRequest.request({
                    path: "/api-third-party/service/datacenter/plugin_control",
                    type: "GET",
                    data: {
                        appId: appId,
                        info: JSON.stringify({method:"saveConfig",data:tmp,type:"base"})
                    },
                    success: function (data) {
                        var response = jQuery.parseJSON(data);
                        if (response.code != 0) {
                            console.log(data);
                            alert("Frpc配置保存错误：" + response.msg);
                            return;
                        }
                        //alert("配置保存成功");
                        toast('配置保存成功!')
                    }
                });


            },
            runSS: function (item) {
                method = "";
                if (item) {
                    method = "runSS";
                } else {
                    method = "stopSS";
                }
                router_app.$data.status = "执行中...";
                alert(method);
                routerRequest.request({
                    path: "/api-third-party/service/datacenter/plugin_control",
                    type: "GET",
                    data: {
                        appId: appId,
                        info: JSON.stringify({method: method})
                    },
                    success: function (data) {
                        var response = jQuery.parseJSON(data);
                        // if (response.code != 0) {
                        //     console.log(data);
                        //     alert("错误：" + response.msg);
                        //     return;
                        // }
                        alert(data);
                        routerRequest.request({
                            path: "/api-third-party/service/datacenter/plugin_control",
                            type: "GET",
                            data: {
                                appId: appId,
                                info: JSON.stringify({method: "getStatus"})
                            },
                            success: function (data) {
                                // alert(data)
                                var response = jQuery.parseJSON(data);
                                if (response.code != 0) {
                                    console.log(data);
                                    alert("getStatus：" + response.msg);
                                    return;
                                }
                                //alert(data);

                                if (response.data.status != "") {
                                    router_app.$data.run_status = true;
                                    router_app.$data.status = response.data.status;

                                } else {
                                    router_app.$data.run_status = false;
                                    router_app.$data.status = "未运行";
                                }
                                router_app.$data.version = response.data.version;

                            },
                            error: function (data) {
                                alert("getStatus:" + data);
                            }
                        });

                    },
                    error: function (data) {
                        alert("plugin_control:" + data);
                    }
                });
            },//跳转
            skip() {
                if (this.checkSlide()) {
                    this.restSlide();
                } else {
                    //alert('You click the slide!')
                }
            },
            //滑动开始
            touchStart(e) {
                // 记录初始位置
                this.startX = e.touches[0].clientX;
            },
            //滑动结束
            touchEnd(e) {
                // 当前滑动的父级元素
                let parentElement = e.currentTarget.parentElement;
                // 记录结束位置
                this.endX = e.changedTouches[0].clientX;
                // 左滑
                if (parentElement.dataset.type == 0 && this.startX - this.endX > 30) {
                    this.restSlide();
                    parentElement.dataset.type = 1;
                }
                // 右滑
                if (parentElement.dataset.type == 1 && this.startX - this.endX < -30) {
                    this.restSlide();
                    parentElement.dataset.type = 0;
                }
                this.startX = 0;
                this.endX = 0;
            },
            //判断当前是否有滑块处于滑动状态
            checkSlide() {
                let listItems = document.querySelectorAll('.list-item');
                for (let i = 0; i < listItems.length; i++) {
                    if (listItems[i].dataset.type == 1) {
                        return true;
                    }
                }
                return false;
            },
            //复位滑动状态
            restSlide() {
                let listItems = document.querySelectorAll('.list-item');
                // 复位
                for (let i = 0; i < listItems.length; i++) {
                    listItems[i].dataset.type = 0;
                }
            },
            //删除
            deleteItem(index) {
                // 复位
                this.restSlide();
                // 删除
                router_app.$data.nodeList.splice(index, 1);
            },
            //删除lan
            deleteLanItem(index) {
                // 复位
                this.restSlide();
                // 删除
                router_app.$data.lanList.splice(index, 1);
            }

        }
    });

    var status = 0;
    var appId = "2882303761517844579";

    $(document).ready(function () {
        $("#authorizeButton").click(function () {
            if (!routerRequest.hasAccessToken()) {
                routerRequest.authorize(window.location.href, appId);
            }
        });
        loadconfig();

    });

    function loadconfig() {
        //设置
        routerRequest.request({
            path: "/api-third-party/service/datacenter/config_info",
            type: "GET",
            data: {
                appId: appId,
                key: "nodeList"
            },
            success: function (data) {
                //alert(data)
                var response = jQuery.parseJSON(data);
                if (response.code != 0) {
                    console.log(data);
                    toast("节点列表错误：" + response.msg);
                    return;
                }
                //alert(data);

                nodeListStr = decodeURIComponent(response.value);
                //alert(nodeListStr);
                if (nodeListStr != "") {
                    nodeList = jQuery.parseJSON(nodeListStr);
                    router_app.$data.nodeList = nodeList;
                }
            },
            error: function (data) {
                console.log("error:", data);
                alert("网络失败");
            }
        });


        //插件状态
        routerRequest.request({
            path: "/api-third-party/service/datacenter/plugin_control",
            type: "GET",
            data: {
                appId: appId,
                info: JSON.stringify({method: "getStatus"})
            },
            success: function (data) {

                var response = jQuery.parseJSON(data);
                if (response.code != 0) {
                    console.log(data);
                    toast("method: \"getStatus\" \n错误：" + response.msg);
                    return;
                }
                //alert(data);

                if (response.data.status != "") {
                    router_app.$data.run_status = true;
                    router_app.$data.status = response.data.status;
                } else {
                    router_app.$data.status = "未运行";
                    router_app.$data.run_status = false;
                }
                router_app.$data.version = response.data.version;


            },
            error: function (data) {
                alert("plugin_control:" + data);
            }
        });

    }

    function toast(msg) {
        setTimeout(function () {
            document.getElementsByClassName('toast-wrap')[0].getElementsByClassName('toast-msg')[0].innerHTML = msg;
            var toastTag = document.getElementsByClassName('toast-wrap')[0];
            toastTag.className = toastTag.className.replace('toastAnimate', '');
            setTimeout(function () {
                toastTag.className = toastTag.className + ' toastAnimate';
            }, 100);
        }, 5000);
    }
</script>

</body>
</html>

